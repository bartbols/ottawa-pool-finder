<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ottawa Swim & Skate Finder</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#F5F7FA;
  --surface:#ffffff;
  --surface2:#F8FAFC;
  --border:#E2E8F0;
  --border-focus:#0097A7;
  --text:#0D1B2A;
  --text-dim:#5A6B7D;
  --text-muted:#8A9BB0;
  --accent:#0097A7;
  --accent-light:#E0F7FA;
  --accent-dark:#007B84;
  --blue:#1565C0;
  --blue-light:#E3F2FD;
  --amber:#D97706;
  --amber-light:#FEF3C7;
  --green:#059669;
  --green-light:#D1FAE5;
  --r:12px;
}
html{scroll-behavior:smooth}
body{
  font-family:'Plus Jakarta Sans',sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
}

/* Subtle top stripe */
body::before{
  content:'';display:block;height:4px;
  background:linear-gradient(90deg,var(--accent),#29B6C8,var(--blue));
}

main{max-width:820px;margin:0 auto;padding:40px 20px 80px}

/* Header */
header{text-align:center;margin-bottom:40px}
.eyebrow{
  display:inline-flex;align-items:center;gap:7px;
  background:var(--accent-light);border:1.5px solid #B2EBF2;
  border-radius:40px;padding:6px 16px;
  font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;
  color:var(--accent-dark);margin-bottom:18px;
}
h1{
  font-size:clamp(2rem,5.5vw,3.2rem);font-weight:800;
  color:var(--text);line-height:1.08;letter-spacing:-.025em;margin-bottom:12px;
}
h1 span{color:var(--accent)}
.subtitle{font-size:.97rem;color:var(--text-dim);max-width:460px;margin:0 auto;line-height:1.65}

/* Card */
.card{
  background:var(--surface);
  border:1.5px solid var(--border);
  border-radius:16px;padding:24px;
  box-shadow:0 2px 16px rgba(13,27,42,.06);
  margin-bottom:8px;
}
.clabel{
  font-size:.72rem;font-weight:700;letter-spacing:.09em;text-transform:uppercase;
  color:var(--text-muted);margin-bottom:12px;display:flex;align-items:center;gap:8px;
}
.clabel::before{content:'';width:3px;height:13px;background:var(--accent);border-radius:2px;flex-shrink:0}

/* Activity toggle */
.activity-toggle{display:flex;gap:7px;margin-bottom:20px}
.act-btn{
  flex:1;padding:10px 8px;border-radius:10px;
  border:1.5px solid var(--border);
  background:var(--surface2);color:var(--text-muted);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.83rem;font-weight:600;cursor:pointer;text-align:center;
  transition:all .15s;
}
.act-btn:hover{border-color:#B2EBF2;color:var(--text)}
.act-btn.active-swim{border-color:var(--accent);background:var(--accent-light);color:var(--accent-dark)}
.act-btn.active-skate{border-color:var(--blue);background:var(--blue-light);color:var(--blue)}
.act-btn.active-both{border-color:var(--amber);background:var(--amber-light);color:var(--amber)}

/* Form */
.row2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px}
@media(max-width:480px){.row2{grid-template-columns:1fr}}
label{display:block;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.09em;color:var(--text-muted);margin-bottom:6px}
input[type=date],select#st{
  width:100%;background:var(--surface2);
  border:1.5px solid var(--border);border-radius:10px;
  color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.95rem;padding:11px 14px;outline:none;
  transition:border-color .15s;
}
input[type=date]:focus,select#st:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,151,167,.1)}
select#st{
  appearance:none;-webkit-appearance:none;cursor:pointer;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%235A6B7D' d='M1 1l5 5 5-5'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 13px center;
}
select#st option{background:#fff;color:var(--text)}
.btn{
  width:100%;
  background:var(--accent);
  border:none;border-radius:10px;
  color:#fff;font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.97rem;font-weight:700;padding:13px;
  cursor:pointer;transition:all .15s;letter-spacing:.01em;
}
.btn:hover{background:var(--accent-dark);box-shadow:0 6px 20px rgba(0,151,167,.25);transform:translateY(-1px)}

/* Notice */
.notice{margin-top:12px;padding:10px 14px;border-radius:10px;font-size:.83rem;line-height:1.5;display:none}
.notice.info{background:var(--accent-light);border:1.5px solid #B2EBF2;color:var(--accent-dark)}
.notice.warn{background:var(--amber-light);border:1.5px solid #FDE68A;color:var(--amber)}

/* Data badge */
.data-badge{display:inline-flex;align-items:center;gap:6px;font-size:.74rem;color:var(--text-muted);margin-top:11px}
.data-dot{width:7px;height:7px;border-radius:50%;background:var(--green);flex-shrink:0}
.data-dot.stale{background:var(--amber)}
.data-dot.fallback{background:#EF4444}

/* Results */
.results{margin-top:24px;animation:fadeUp .25s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.rlabel{font-size:1.35rem;font-weight:800;color:var(--text);margin-bottom:3px}
.rsub{font-size:.84rem;color:var(--text-muted);margin-bottom:20px}

/* Section headers */
.section-header{
  font-size:.72rem;font-weight:700;letter-spacing:.09em;text-transform:uppercase;
  margin:18px 0 10px;display:flex;align-items:center;gap:8px;
}
.section-header::before{content:'';width:3px;height:12px;border-radius:2px;flex-shrink:0}
.swim-hdr{color:var(--accent-dark)}.swim-hdr::before{background:var(--accent)}
.skate-hdr{color:var(--blue)}.skate-hdr::before{background:var(--blue)}

/* Pool/rink blocks */
.pblock{
  background:var(--surface);border:1.5px solid var(--border);
  border-radius:var(--r);overflow:hidden;margin-bottom:10px;
  box-shadow:0 1px 6px rgba(13,27,42,.04);
  transition:border-color .15s,box-shadow .15s;
}
.pblock:hover{border-color:#B2EBF2;box-shadow:0 3px 14px rgba(0,151,167,.1)}
.pblock.skate-block:hover{border-color:#BBDEFB;box-shadow:0 3px 14px rgba(21,101,192,.09)}
.phead{padding:16px 18px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;cursor:pointer;user-select:none}
.pname{font-size:.97rem;font-weight:700;color:var(--text);margin-bottom:3px;line-height:1.3}
.pname a{
  font-size:.69rem;font-weight:600;color:var(--accent);
  text-decoration:none;margin-left:6px;vertical-align:middle;
  opacity:.8;transition:opacity .15s;
}
.pname a:hover{opacity:1}
.parea{font-size:.78rem;color:var(--text-muted)}
.ptags{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px}
.tag{font-size:.68rem;padding:3px 8px;border-radius:20px;font-weight:600;white-space:nowrap}
.t-open{background:var(--accent-light);color:var(--accent-dark);border:1px solid #B2EBF2}
.t-skate{background:var(--blue-light);color:var(--blue);border:1px solid #BBDEFB}
.t-free{background:var(--amber-light);color:var(--amber);border:1px solid #FDE68A}
.t-wave{background:#E0F2F7;color:#0277BD;border:1px solid #B3E5FC}
.chev{flex-shrink:0;color:var(--text-muted);font-size:.85rem;transition:transform .2s;margin-top:2px}
.pblock.open .chev{transform:rotate(180deg)}
.spanel{display:none;border-top:1.5px solid var(--border);padding:14px 18px 16px;background:var(--surface2)}
.pblock.open .spanel{display:block}
.stitle{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--accent);margin-bottom:10px}
.skate-block .stitle{color:var(--blue)}
.srow{
  display:flex;align-items:center;justify-content:space-between;
  padding:9px 12px;border-radius:8px;margin-bottom:6px;
  background:var(--surface);border:1px solid var(--border);gap:10px;
}
.srow.free{background:var(--accent-light);border-color:#B2EBF2}
.styp{font-size:.85rem;font-weight:500;flex:1;color:var(--text)}
.stim{font-size:.85rem;font-weight:700;color:var(--accent);white-space:nowrap}
.skate-block .stim{color:var(--blue)}
.fbadge{font-size:.66rem;background:var(--amber);color:#fff;padding:2px 7px;border-radius:10px;font-weight:700;letter-spacing:.04em;white-space:nowrap}
.extlink{
  display:inline-flex;align-items:center;gap:4px;margin-top:12px;
  font-size:.79rem;color:var(--accent);text-decoration:none;font-weight:600;
  border-bottom:1px solid transparent;transition:border-color .15s;
}
.extlink:hover{border-color:var(--accent)}

/* No results */
.no-results{
  text-align:center;padding:44px 20px;
  background:var(--surface);border:1.5px solid var(--border);
  border-radius:var(--r);color:var(--text-dim);
}
.no-results .big{font-size:2.2rem;margin-bottom:10px}
.no-results p{font-size:.92rem;line-height:1.65}

/* Later section */
.later-sec{margin-top:24px}
.llabel{
  font-size:.72rem;font-weight:700;letter-spacing:.09em;text-transform:uppercase;
  color:var(--text-muted);margin-bottom:12px;display:flex;align-items:center;gap:8px;
}
.llabel::before{content:'';width:3px;height:12px;background:var(--border);border-radius:2px}

/* Disclaimer */
.disc{
  margin-top:28px;padding:13px 17px;
  background:var(--surface);border:1.5px solid var(--border);
  border-radius:10px;font-size:.78rem;color:var(--text-muted);line-height:1.65;text-align:center;
}
.disc a{color:var(--accent);font-weight:600}
</style>
</head>
<body>
<main>
  <header>
    <div class="eyebrow">üèä ‚õ∏Ô∏è Ottawa Finder</div>
    <h1>Find your <span>swim or skate</span></h1>
    <p class="subtitle">Pick a date and time to see which Ottawa facilities have public swimming or skating open.</p>
  </header>

  <div class="card">
    <div class="clabel">What are you looking for?</div>
    <div class="activity-toggle">
      <button class="act-btn active-swim" id="btn-swim" onclick="setActivity('swim')">üèä Swim</button>
      <button class="act-btn" id="btn-skate" onclick="setActivity('skate')">‚õ∏Ô∏è Skate</button>
      <button class="act-btn" id="btn-both" onclick="setActivity('both')">üèä + ‚õ∏Ô∏è All</button>
    </div>
    <div id="sub-filter" style="margin-bottom:16px;display:none"></div>
    <div class="clabel">When?</div>
    <div class="row2">
      <div><label for="sd">Date</label><input type="date" id="sd"/></div>
      <div><label for="st">Time</label><select id="st"></select></div>
    </div>
    <button class="btn" onclick="doSearch()">Find open venues ‚Üí</button>
    <div id="notice" class="notice"></div>
    <div id="loc-debug" style="display:none;margin-top:10px;font-size:.74rem;color:var(--text-muted)"></div>
    <div id="data-badge" class="data-badge" style="display:none">
      <div id="data-dot" class="data-dot"></div>
      <span id="data-label"></span>
    </div>
  </div>

  <div id="results"></div>

  <div class="disc">
    Schedule data is fetched nightly from Ottawa.ca.
    Always <a href="https://ottawa.ca/en/recreation-and-parks" target="_blank">verify on Ottawa.ca</a> before heading out.
    <strong>Play Free</strong> = free admission ages 17 &amp; under + accompanying adult, Saturdays only.
  </div>
</main>
<script>

function fmt(n){
  const h=Math.floor(n/60),m=n%60,ap=h<12?'am':'pm',h12=h===0?12:h>12?h-12:h;
  return m?`${h12}:${String(m).padStart(2,'0')} ${ap}`:`${h12} ${ap}`;
}
function t(h,m){return h*60+(m||0)}


// ‚îÄ‚îÄ Fallback data (swim only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FALLBACK_POOLS=[
  {id:'splash-wave-pool',name:'Splash Wave Pool',url:'https://ottawa.ca/en/recreation-and-parks/facilities/place-listing/splash-wave-pool',wave:true,sessions:[
    {day:1,label:'Public Swim - wave tank and warm pool',start:t(11,0),end:t(13,0),playFree:false},
    {day:2,label:'Public Swim - wave tank and warm pool',start:t(12,0),end:t(13,0),playFree:false},
    {day:2,label:'Public Swim - wave tank and warm pool',start:t(16,30),end:t(21,0),playFree:false},
    {day:3,label:'Public Swim - wave tank and warm pool',start:t(9,30),end:t(13,0),playFree:false},
    {day:4,label:'Public Swim - wave tank and warm pool',start:t(12,0),end:t(13,0),playFree:false},
    {day:4,label:'Public Swim - wave tank and warm pool',start:t(16,30),end:t(21,0),playFree:false},
    {day:5,label:'Public Swim - wave tank and warm pool',start:t(9,30),end:t(13,0),playFree:false},
    {day:6,label:'Public Swim - warm pool only',start:t(12,0),end:t(13,0),playFree:true},
    {day:0,label:'Public Swim - warm pool only',start:t(12,0),end:t(13,0),playFree:false},
  ]},
  {id:'ray-friel-recreation-complex',name:'Ray Friel Recreation Complex',url:'https://ottawa.ca/en/recreation-and-parks/facilities/place-listing/ray-friel-recreation-complex',wave:true,sessions:[
    {day:4,label:'Public swim',start:t(17,0),end:t(19,30),playFree:false},
    {day:6,label:'Public swim',start:t(12,0),end:t(13,0),playFree:true},
    {day:0,label:'Public swim',start:t(12,0),end:t(13,0),playFree:false},
  ]},
];
const FALLBACK_RINKS=[];

let POOLS=[];
let RINKS=[];
let dataSource='loading';
let scrapedAt=null;
let userCoords=null;
let activity='swim';    // 'swim' | 'skate' | 'all'
let subActivity='all';  // 'all' | 'public' | 'lane' | 'public-skate' | 'family-skate'

// ‚îÄ‚îÄ Geolocation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getUserLocation(){
  return new Promise(resolve=>{
    if(!navigator.geolocation) return resolve(null);
    navigator.geolocation.getCurrentPosition(
      pos=>resolve({lat:pos.coords.latitude,lng:pos.coords.longitude}),
      ()=>resolve(null),
      {timeout:6000,maximumAge:60000}
    );
  });
}

// ‚îÄ‚îÄ Haversine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function haversine(lat1,lng1,lat2,lng2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLng=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
  const d=R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return isNaN(d)?null:d;
}

// ‚îÄ‚îÄ Venue coords + addresses ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const VENUE_COORDS=[
  // Pools
  {k:'splash wave',         lat:45.4375,lng:-75.6004, addr:'2040 Ogilvie Rd'},
  {k:'ray friel',           lat:45.4720,lng:-75.4929, addr:'1585 Tenth Line Rd'},
  {k:'dupuis',              lat:45.4544,lng:-75.4636, addr:'2263 Portobello Blvd'},
  {k:'nepean sportsplex',   lat:45.3271,lng:-75.7447, addr:'1701 Woodroffe Ave'},
  {k:'sensplex',            lat:45.2972,lng:-75.9093, addr:'1565 Maple Grove Rd'},
  {k:'macquarrie',          lat:45.4663,lng:-75.5451, addr:'1490 Youville Dr'},
  {k:'brewer',              lat:45.3894,lng:-75.6919, addr:'100 Brewer Way'},
  {k:'kirwan',              lat:45.3674,lng:-75.6573, addr:'1300 Kitchener Ave'},
  {k:'jack purcell',        lat:45.4158,lng:-75.6894, addr:'320 Jack Purcell Ln'},
  {k:'mcnabb',              lat:45.4088,lng:-75.7022, addr:'180 Percy St'},
  {k:'plant',               lat:45.4078,lng:-75.7146, addr:'930 Somerset St W'},
  {k:'pinecrest',           lat:45.3478,lng:-75.7738, addr:'2250 Torquay Ave'},
  {k:'walter baker',        lat:45.2804,lng:-75.7625, addr:'100 Malvern Dr'},
  {k:'goulbourn',           lat:45.2630,lng:-75.9078, addr:'1500 Shea Rd'},
  {k:'cardelrec',           lat:45.2630,lng:-75.9078, addr:'1500 Shea Rd'},
  {k:'richmond',            lat:45.1956,lng:-75.8378, addr:'6095 Perth St'},
  {k:'lowertown',           lat:45.4347,lng:-75.6813, addr:'40 Cobourg St'},
  {k:'sawmill',             lat:45.3498,lng:-75.6364, addr:"3380 D'Aoust Ave"},
  {k:'minto',               lat:45.2529,lng:-75.7341, addr:'3500 Cambrian Rd'},
  {k:'richcraft',           lat:45.3405,lng:-75.9304, addr:'4101 Innovation Dr'},
  // Rinks (many shared with pools above; unique ones below)
  {k:'earl armstrong',      lat:45.4378,lng:-75.6016, addr:'2020 Ogilvie Rd'},
  {k:'lois kemp',           lat:45.4607,lng:-75.5352, addr:'500 Blackburn Hamlet'},
  {k:'r.j. kennedy',        lat:45.4435,lng:-75.5110, addr:'1200 Marenger St'},
  {k:'st. laurent',         lat:45.4304,lng:-75.6222, addr:'525 C√¥te-de-Sable St'},
  {k:'bernard grandmaitre', lat:45.4658,lng:-75.4791, addr:'650 C√¥te St'},
  {k:'bernard grandma√Ætre', lat:45.4658,lng:-75.4791, addr:'650 C√¥te St'},
  {k:'j.a. dulude',         lat:45.3882,lng:-75.7532, addr:'950 Woodroffe Ave'},
  {k:'jim durrell',         lat:45.3660,lng:-75.6368, addr:'1265 Walkley Rd'},
  {k:'osgoode',             lat:45.1451,lng:-75.5995, addr:'5526 Main St'},
  {k:'tony graham',         lat:45.2589,lng:-75.9014, addr:'3500 Cambrian Rd'},
  {k:'w. erskine',          lat:45.3439,lng:-75.9075, addr:'4101 Innovation Dr'},
  {k:'erskine johnston',    lat:45.3439,lng:-75.9075, addr:'4101 Innovation Dr'},
];

function infoForVenue(venue){
  const name=venue.name.toLowerCase();
  const entry=VENUE_COORDS.find(e=>name.includes(e.k));
  const addr=entry?entry.addr:(venue.address||'');
  const mapsUrl='https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(venue.name+' Ottawa');
  if(!entry||!userCoords) return {dist:null,addr:addr,mapsUrl:mapsUrl};
  return {dist:haversine(userCoords.lat,userCoords.lng,entry.lat,entry.lng),addr:addr,mapsUrl:mapsUrl};
}

// ‚îÄ‚îÄ Load scraped data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadScheduleData(){
  try{
    const res=await fetch('schedule_data.json?_='+Date.now());
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data=await res.json();
    POOLS=(data.pools||[]).map(p=>({...p,wave:p.wave||false}));
    RINKS=(data.rinks||[]);
    scrapedAt=data.scraped_at?new Date(data.scraped_at):null;
    const ageHours=scrapedAt?(Date.now()-scrapedAt)/3600000:999;
    dataSource=ageHours<48?'live':'stale';
    showDataBadge();
  }catch(e){
    console.warn('Could not load schedule_data.json, using fallback.',e);
    POOLS=FALLBACK_POOLS;
    RINKS=FALLBACK_RINKS;
    dataSource='fallback';
    showDataBadge();
  }
}

function showDataBadge(){
  const badge=document.getElementById('data-badge');
  const dot=document.getElementById('data-dot');
  const lbl=document.getElementById('data-label');
  badge.style.display='inline-flex';
  if(dataSource==='live'){
    dot.className='data-dot';
    const d=scrapedAt.toLocaleDateString('en-CA',{month:'short',day:'numeric',year:'numeric'});
    lbl.textContent='Schedule data last updated '+d;
  }else if(dataSource==='stale'){
    dot.className='data-dot stale';
    lbl.textContent='Schedule data may be outdated - verify on Ottawa.ca';
  }else{
    dot.className='data-dot fallback';
    lbl.textContent='Using offline schedule (Feb 2026) - verify on Ottawa.ca';
  }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async function init(){
  const sel=document.getElementById('st');
  for(let h=0;h<24;h++){
    for(let m=0;m<60;m+=30){
      const val=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');
      const ap=h<12?'am':'pm',h12=h===0?12:h>12?h-12:h;
      const label=m===0?(h12+':00 '+ap):(h12+':30 '+ap);
      const opt=document.createElement('option');
      opt.value=val; opt.textContent=label;
      sel.appendChild(opt);
    }
  }
  const now=new Date();
  document.getElementById('sd').value=now.toISOString().split('T')[0];
  const roundedMins=Math.floor((now.getHours()*60+now.getMinutes())/30)*30;
  const rh=Math.floor(roundedMins/60),rm=roundedMins%60;
  sel.value=String(rh).padStart(2,'0')+':'+String(rm).padStart(2,'0');

  updateNotice();

  [userCoords]=await Promise.all([getUserLocation(),loadScheduleData()]);

  const dbg=document.getElementById('loc-debug');
  if(userCoords){
    dbg.textContent='Location: '+userCoords.lat.toFixed(5)+', '+userCoords.lng.toFixed(5)+' - results sorted by distance';
    
  }else{
    dbg.textContent='Location unavailable - results sorted alphabetically';
    
  }
  dbg.style.display='block';
})();

function getDay(){
  const v=document.getElementById('sd').value;
  return v?new Date(v+'T12:00:00').getDay():null;
}
function getMins(){
  const v=document.getElementById('st').value;
  if(!v) return 0;
  const parts=v.split(':').map(Number);
  return parts[0]*60+parts[1];
}

document.getElementById('sd').addEventListener('change',updateNotice);

function updateNotice(){
  const n=document.getElementById('notice'),day=getDay();
  if(day===null){n.style.display='none';return}
  if(day===6){
    n.className='notice info';
    n.innerHTML='Saturday! Play Free is active - kids 17 & under swim free at marked sessions.';
  }else{
    n.className='notice warn';
    n.innerHTML='Play Free is Saturdays only. Regular fees apply today.';
  }
  n.style.display='block';
}

// ‚îÄ‚îÄ Activity toggle & sub-filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setActivity(a) {
  activity = a;
  subActivity = 'all';
  document.getElementById('btn-swim').className  = 'act-btn' + (a==='swim'  ? ' active-swim'  : '');
  document.getElementById('btn-skate').className = 'act-btn' + (a==='skate' ? ' active-skate' : '');
  document.getElementById('btn-both').className  = 'act-btn' + (a==='all'   ? ' active-both'  : '');
  renderSubFilter();
}

function setSubActivity(val) {
  subActivity = val;
  renderSubFilter();
}

function renderSubFilter() {
  const el = document.getElementById('sub-filter');
  if (activity === 'all') { el.style.display='none'; el.innerHTML=''; return; }
  el.style.display = 'block';

  const labelStyle = 'font-size:.67rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--text-muted);margin-bottom:7px;';
  const base = 'display:inline-flex;align-items:center;padding:5px 12px;border-radius:20px;font-size:.76rem;font-weight:600;cursor:pointer;border:1.5px solid;margin-right:5px;margin-bottom:4px;font-family:inherit;';

  function chip(val, label, color, bg, border) {
    const on = subActivity === val;
    const style = on
      ? base + `background:${bg};color:${color};border-color:${border};`
      : base + `background:#F8FAFC;color:var(--text-muted);border-color:var(--border);`;
    return `<button style="${style}" onclick="setSubActivity('${val}')">${label}</button>`;
  }

  let html = `<div style="${labelStyle}">Which type?</div>`;
  if (activity === 'swim') {
    html += chip('all',    '‚óè All swim',    'var(--accent-dark)', 'var(--accent-light)', 'var(--accent)');
    html += chip('public', '‚óã Public swim', 'var(--accent-dark)', 'var(--accent-light)', 'var(--accent)');
    html += chip('lane',   '‚óã Lane swim',   'var(--accent-dark)', 'var(--accent-light)', 'var(--accent)');
  } else {
    html += chip('all',          '‚óè All skate',    'var(--blue)', 'var(--blue-light)', 'var(--blue)');
    html += chip('public-skate', '‚óã Public skate', 'var(--blue)', 'var(--blue-light)', 'var(--blue)');
    html += chip('family-skate', '‚óã Family skate', 'var(--blue)', 'var(--blue-light)', 'var(--blue)');
  }
  el.innerHTML = html;
}

// ‚îÄ‚îÄ Session keyword matching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SWIM_PUBLIC_KW  = ['public swim','wave swim'];
const SWIM_LANE_KW    = ['lane swim'];
const SKATE_PUBLIC_KW = ['public skate','public skating'];
const SKATE_FAMILY_KW = ['family skate','family skating'];

function sessionMatchesFilter(s, isSkate) {
  const lbl = s.label.toLowerCase();
  if (!isSkate) {
    if (subActivity === 'all')    return true;
    if (subActivity === 'public') return SWIM_PUBLIC_KW.some(k => lbl.includes(k));
    if (subActivity === 'lane')   return SWIM_LANE_KW.some(k => lbl.includes(k));
  } else {
    if (subActivity === 'all')          return true;
    if (subActivity === 'public-skate') return SKATE_PUBLIC_KW.some(k => lbl.includes(k));
    if (subActivity === 'family-skate') return SKATE_FAMILY_KW.some(k => lbl.includes(k));
  }
  return false;
}

// ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildActive(venues, day, mins, isSkate) {
  return venues.map(function(venue) {
    const hits = (venue.sessions||[]).filter(s =>
      s.day===day && mins>=s.start && mins<s.end && sessionMatchesFilter(s, isSkate)
    );
    const info = infoForVenue(venue);
    return {venue, hits, dist:info.dist, addr:info.addr, mapsUrl:info.mapsUrl};
  }).filter(r => r.hits.length);
}

function sortResults(active) {
  const hasDistances = userCoords && active.some(r => r.dist !== null);
  if (hasDistances) {
    active.sort((a,b) => {
      if (a.dist===null && b.dist===null) return a.venue.name.localeCompare(b.venue.name);
      if (a.dist===null) return 1;
      if (b.dist===null) return -1;
      return a.dist - b.dist;
    });
  } else {
    active.sort((a,b) => a.venue.name.localeCompare(b.venue.name));
  }
  return hasDistances;
}

function doSearch() {
  const dateVal = document.getElementById('sd').value;
  const timeVal = document.getElementById('st').value;
  if (!dateVal||!timeVal) { alert('Please pick both a date and time.'); return; }

  const day = getDay(), mins = getMins();
  const dateObj = new Date(dateVal+'T12:00:00');
  const dateStr = dateObj.toLocaleDateString('en-CA',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

  const showSwim  = activity==='swim'  || activity==='all';
  const showSkate = activity==='skate' || activity==='all';

  const activePools = showSwim  ? buildActive(POOLS, day, mins, false) : [];
  const activeRinks = showSkate ? buildActive(RINKS, day, mins, true)  : [];

  const hasDistPools = sortResults(activePools);
  const hasDistRinks = sortResults(activeRinks);
  const hasDistances = hasDistPools || hasDistRinks;

  const laterPools=[], laterRinks=[];
  if (showSwim) POOLS.forEach(p => {
    (p.sessions||[]).filter(s => s.day===day && s.start>mins && sessionMatchesFilter(s,false))
      .forEach(s => laterPools.push({venue:p, s}));
  });
  if (showSkate) RINKS.forEach(r => {
    (r.sessions||[]).filter(s => s.day===day && s.start>mins && sessionMatchesFilter(s,true))
      .forEach(s => laterRinks.push({venue:r, s}));
  });
  laterPools.sort((a,b) => a.s.start-b.s.start);
  laterRinks.sort((a,b) => a.s.start-b.s.start);

  render(activePools, activeRinks, laterPools, laterRinks, dateStr, mins, hasDistances, showSwim, showSkate);
}

function toggle(el) { el.classList.toggle('open'); }

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function venueCard(r, isSkate, timeLabel) {
  const {venue, hits, dist, addr, mapsUrl} = r;
  const hasFree = hits.some(s => s.playFree);
  const addrText = addr ? 'üìç '+addr : '';
  const distText = (dist!==null && !isNaN(dist))
    ? (dist<1 ? (dist*1000).toFixed(0)+' m' : dist.toFixed(1)+' km')+' away' : '';
  const addrLine = addrText&&distText ? addrText+' ¬∑ '+distText : addrText||distText;
  const blockClass = 'pblock open'+(isSkate?' skate-block':'');
  const openTag = isSkate
    ? '<span class="tag t-skate">‚õ∏Ô∏è Open at '+timeLabel+'</span>'
    : '<span class="tag t-open">üèä Open at '+timeLabel+'</span>';

  let h = '<div class="'+blockClass+'" onclick="toggle(this)">'
    +'<div class="phead"><div>'
    +'<div class="pname">'+venue.name
    +(mapsUrl ? ' <a href="'+mapsUrl+'" target="_blank" onclick="event.stopPropagation()" style="font-size:.72rem;font-weight:600;color:var(--accent);text-decoration:none;vertical-align:middle;margin-left:6px" title="Open in Google Maps">üìç Maps</a>' : '')
    +'</div>'
    +(addrLine ? '<div class="parea">'+addrLine+'</div>' : '')
    +'<div class="ptags">'+openTag
    +(hasFree ? '<span class="tag t-free">Play Free</span>' : '')
    +(venue.wave ? '<span class="tag t-wave">üåä Wave pool</span>' : '')
    +'</div></div><div class="chev">‚ñæ</div></div>'
    +'<div class="spanel"><div class="stitle">Sessions open at '+timeLabel+'</div>';

  hits.forEach(s => {
    h += '<div class="srow'+(s.playFree?' free':'')+'"><div class="styp">'+s.label+'</div>'
      +'<div style="display:flex;align-items:center;gap:8px">'
      +(s.playFree ? '<span class="fbadge">PLAY FREE</span>' : '')
      +'<div class="stim">'+fmt(s.start)+' ‚Äì '+fmt(s.end)+'</div>'
      +'</div></div>';
  });

  h += '<a class="extlink" href="'+venue.url+'" target="_blank">Full schedule on Ottawa.ca ‚Üó</a>'
    +'</div></div>';
  return h;
}

function render(activePools, activeRinks, laterPools, laterRinks, dateStr, mins, hasDistances, showSwim, showSkate) {
  const total = activePools.length + activeRinks.length;
  const timeLabel = fmt(mins);
  const sortNote = hasDistances
    ? ' <span style="font-size:.78rem;color:var(--text-muted);font-weight:500"> ‚Äî sorted by distance</span>' : '';
  const typeLabel = showSwim&&showSkate ? 'venues' : showSwim ? 'pools' : 'rinks';

  let h = '<div class="results">'
    +'<div class="rlabel">'+total+' '+typeLabel+' open at '+timeLabel+sortNote+'</div>'
    +'<div class="rsub">'+dateStr+'</div>';

  if (!total) {
    const icon = showSwim&&showSkate ? 'üèä ‚õ∏Ô∏è' : showSwim ? 'üåä' : '‚õ∏Ô∏è';
    h += '<div class="no-results"><div class="big">'+icon+'</div>'
      +'<p>No open sessions found at <strong>'+timeLabel+'</strong>.<br>Try a different time or activity type.</p></div>';
  } else {
    if (showSwim&&showSkate&&activePools.length)
      h += '<div class="section-header swim-hdr">üèä Swimming ('+activePools.length+')</div>';
    activePools.forEach(r => { h += venueCard(r, false, timeLabel); });
    if (showSwim&&showSkate&&activeRinks.length)
      h += '<div class="section-header skate-hdr">‚õ∏Ô∏è Skating ('+activeRinks.length+')</div>';
    activeRinks.forEach(r => { h += venueCard(r, true, timeLabel); });
  }

  const laterAll = [
    ...laterPools.map(x => ({...x, isSkate:false})),
    ...laterRinks.map(x => ({...x, isSkate:true})),
  ].sort((a,b) => a.s.start-b.s.start);

  if (laterAll.length) {
    h += '<div class="later-sec"><div class="llabel">More sessions later today</div>';
    laterAll.forEach(({venue, s, isSkate}) => {
      const icon = isSkate ? '‚õ∏Ô∏è' : 'üèä';
      h += '<div class="srow'+(s.playFree?' free':'')+'" style="margin-bottom:8px">'
        +'<div><div style="font-size:.78rem;color:var(--text-muted);margin-bottom:2px">'+icon+' '+venue.name+'</div>'
        +'<div class="styp">'+s.label+'</div></div>'
        +'<div style="display:flex;align-items:center;gap:8px;flex-shrink:0">'
        +(s.playFree ? '<span class="fbadge">PLAY FREE</span>' : '')
        +'<div class="stim">'+fmt(s.start)+' ‚Äì '+fmt(s.end)+'</div>'
        +'</div></div>';
    });
    h += '</div>';
  }

  h += '</div>';
  const area = document.getElementById('results');
  area.innerHTML = h;
  area.scrollIntoView({behavior:'smooth', block:'start'});
}

</script>
</body>
</html>
